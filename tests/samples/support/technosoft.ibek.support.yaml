# yaml-language-server: $schema=../schemas/ibek.support.schema.json

module: motorTML
defs:
  - name: Controller
    description: |-
      Technosoft motion controller connected to a serial line
    args:
      - type: id
        name: controllerName
        description: |-
          The name of the controller
      # unfortunately we have to make sure this matches the axis count because they
      # are declared after this entity so we cant use their counter
      - type: int
        name: axes
        description: |-
          Number of axes
      - type: str
        name: P
        description: |-
          Device PV Prefix
      - type: str
        name: TTY
        description: |-
          TTY
      - type: int
        name: hostid
        description: |-
          Host ID
      - type: enum
        name: homing
        description: |-
          Homing direction
        default: LSN
        values:
          LSN:
          LSP:
      - type: str
        name: CONFIG
        description: |-
          TML Configuration
        default: |-
          ndsCreateDevice "TechnosoftTML", "", "FILE=/tmp/,NAXIS={{axes}},DEV_PATH=/dev/ttyS0,HOST_ID={{hostid}},

    values:
      - name: axisConfiguration
        description: collects the axis configuration from axis entities
        value: |-
          {{ __utils__.set_var('motorTML.axisConfiguration',[]) }}

    pre_init:
      - value: |
          {{CONFIG}} {{",".join(__utils__.get_var('motorTML.axisConfiguration')) }}"
          # the next line is hard coded from Andrea's example for comparison
          ndsCreateDevice "TechnosoftTML", "", "FILE=/tmp/,NAXIS=4,DEV_PATH=/dev/ttyS0,HOST_ID=1, AXIS_SETUP_0=$(SUPPORT)/motorTechnosoft/tml_lib/config/config.txt,AXIS_ID_0=1,AXIS_HOMING_SW_0=LSN,AXIS_SETUP_1=$(SUPPORT)/motorTechnosoft/tml_lib/config/config.txt,AXIS_ID_1=2,AXIS_HOMING_SW_1=LSN,AXIS_SETUP_2=$(SUPPORT)/motorTechnosoft/tml_lib/config/config.txt,AXIS_ID_2=3,AXIS_HOMING_SW_2=LSN,AXIS_SETUP_3=$(SUPPORT)/motorTechnosoft/tml_lib/config/config.txt,AXIS_ID_3=4,AXIS_HOMING_SW_3=LSN"

  - name: Axis
    description: |-
      Technosoft motion axis
    args:
      - type: object
        name: controller
        description: |-
          Reference to the controller
      - type: str
        name: axisName
        description: |-
          The axis name
      - type: str
        name: CONFIG
        description: |-
          Axis configuration string to add to the controller configuration
        default: |-
          {%- set num = __utils__.counter("motorTML.axisCount", start=0) -%}
          AXIS_SETUP_{{num}}=$(SUPPORT)/motorTechnosoft/tml_lib/config/config.txt,AXIS_ID_{{num}}={{num+1}},AXIS_HOMING_SW_{{num}}=LSN
    values:
      - name: axisConfiguration
        description: Adds an axis configuration entry to the controller's list
        value: |-
          {{ __utils__.get_var('motorTML.axisConfiguration').append(CONFIG) }}
