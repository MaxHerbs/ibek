# yaml-language-server: $schema=../schemas/ibek.support.schema.json

module: motorTML
defs:
  - name: Controller
    description: |-
      Technosoft motion controller connected to a serial line
    args:
      - type: id
        name: controllerName
        description: |-
          The name of the controller
      - type: str
        name: P
        description: |-
          Device PV Prefix
      - type: str
        name: TTY
        description: |-
          TTY
      - type: int
        name: hostid
        description: |-
          Host ID
      - type: enum
        name: homing
        description: |-
          Homing direction
        default: LSN
        values:
          LSN:
          LSP:
      - type: str
        name: CONFIG
        description: |-
          TML Configuration
        # set axes should be in {%%} but I need to fix order of evaluation
        default: |-
          set axes = __utils__.counters["motorTML.axisCount"].current
          ndsCreateDevice "TechnosoftTML", "", "FILE=/tmp/,NAXIS={{axes}},DEV_PATH=/dev/ttyS0,HOST_ID={{hostid}},

    values:
      - name: axisConfiguration
        description: collects the axis configuration from axis entities
        value: |-
          {{ __utils__.set_var('motorTML.axisConfiguration',[]) }}

    pre_init:
      - value: |
          {{CONFIG}}{{",".join(__utils__.get_var('motorTML.axisConfiguration')) }}

  - name: Axis
    description: |-
      Technosoft motion axis
    args:
      - type: object
        name: controller
        description: |-
          Reference to the controller
      - type: str
        name: axisName
        description: |-
          The axis number
      - name: num
        description: Counts the number of axes declared
        default: |-
          {{ __utils__.counter("motorTML.axisCount", start=0) }}
      - type: str
        name: CONFIG
        description: |-
          Axis configuration string to add to the controller configuration
        default: |-
          {{controller.hostid}}AXIS_SETUP_{{num}}=$(SUPPORT)/motorTechnosoft/tml_lib/config/config.txt,AXIS_ID_{{num}}={{num}},AXIS_HOMING_SW_{{num}}=LSN

    values:
      - name: axisConfiguration
        description: Adds an axis configuration entry to the controller's list
        value: |-
          {{ __utils__.get_var('motorTML.axisConfiguration').append(CONFIG) }}
